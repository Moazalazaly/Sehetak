<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign Up - Sehetak</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        .form-container {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin: 20px 0;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        input:focus, select:focus, textarea:focus {
            border-color: #0b8bcc;
            outline: none;
            box-shadow: 0 0 0 3px rgba(11, 139, 204, 0.1);
        }
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        button {
            background-color: #0b8bcc;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            width: 100%;
            transition: background-color 0.3s ease;
        }
        button:hover {
            background-color: #0970a3;
        }
        .message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            font-weight: 500;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .login-link {
            text-align: center;
            margin-top: 15px;
        }
        .login-link a {
            color: #4CAF50;
            text-decoration: none;
        }
        .login-link a:hover {
            text-decoration: underline;
        }
        .error-message {
            color: #dc3545;
            font-size: 0.9em;
            margin-top: 5px;
            display: none;
        }
        .role-badge {
            background: #e3f2fd;
            color: #0b8bcc;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            display: inline-block;
        }
        .section-title {
            color: #2c3e50;
            font-size: 1.2rem;
            margin: 25px 0 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }
        .chronic-disease-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
        }
        .chronic-disease-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .remove-disease {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .remove-disease:hover {
            background: #c82333;
        }
        .add-disease-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            width: auto;
        }
        .add-disease-btn:hover {
            background: #218838;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            .form-container {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="form-container">
        <div id="roleBadge" class="role-badge"></div>
        <h1>Create Your Account</h1>
        <form id="signupForm" novalidate>
            <!-- Common fields -->
            <div class="form-group">
                <label for="fullName">Full Name:</label>
                <input type="text" id="fullName" name="fullName" required>
                <div class="error-message" id="fullName_error"></div>
            </div>

            <div class="form-group">
                <label for="email">Email:</label>
                <input type="email" id="email" name="email" required>
                <div class="error-message" id="email_error"></div>
            </div>

            <div class="form-group">
                <label for="phone">Phone Number:</label>
                <input type="tel" id="phone" name="phone" required>
                <div class="error-message" id="phone_error"></div>
            </div>

            <div class="form-group">
                <label for="password">Password:</label>
                <input type="password" id="password" name="password" required>
                <div class="error-message" id="password_error"></div>
            </div>

            <div class="form-group">
                <label for="confirmPassword">Confirm Password:</label>
                <input type="password" id="confirmPassword" name="confirmPassword" required>
                <div class="error-message" id="confirmPassword_error"></div>
            </div>

            <!-- Patient-specific fields -->
            <div id="patientFields">
                <div class="form-group">
                    <label for="birthDate">Birth Date:</label>
                    <input type="date" id="birthDate" name="birthDate">
                    <div class="error-message" id="birthDate_error"></div>
                </div>

                <div class="form-group">
                    <label for="address">Address:</label>
                    <input type="text" id="address" name="address">
                    <div class="error-message" id="address_error"></div>
                </div>

                <div class="form-group">
                    <label for="bloodType">Blood Type:</label>
                    <select id="bloodType" name="bloodType">
                        <option value="">Select Blood Type</option>
                        <option value="A+">A+</option>
                        <option value="A-">A-</option>
                        <option value="B+">B+</option>
                        <option value="B-">B-</option>
                        <option value="AB+">AB+</option>
                        <option value="AB-">AB-</option>
                        <option value="O+">O+</option>
                        <option value="O-">O-</option>
                    </select>
                    <div class="error-message" id="bloodType_error"></div>
                </div>

                <div class="form-group">
                    <label for="allergies">Allergies:</label>
                    <textarea id="allergies" name="allergies" placeholder="List any allergies (e.g., Penicillin, Peanuts)"></textarea>
                    <div class="error-message" id="allergies_error"></div>
                </div>

                <h3 class="section-title">Chronic Diseases</h3>
                <div id="chronicDiseasesContainer">
                    <!-- Chronic diseases will be added here dynamically -->
                </div>
                <button type="button" class="add-disease-btn" onclick="addChronicDisease()">
                    <i class="fas fa-plus"></i> Add Chronic Disease
                </button>

                <div class="form-group">
                    <label for="gender">Gender:</label>
                    <select id="gender" name="gender">
                        <option value="">Select Gender</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Other">Other</option>
                    </select>
                    <div class="error-message" id="gender_error"></div>
                </div>

                <div class="form-group">
                    <label for="insuranceProvider">Insurance Provider:</label>
                    <select id="insuranceProvider" name="insuranceProvider">
                        <option value="">Select Insurance Provider</option>
                        <option value="none">No Insurance</option>
                    </select>
                    <div class="error-message" id="insuranceProvider_error"></div>
                </div>

                <div class="form-group">
                    <label for="emergencyContact">Emergency Contact:</label>
                    <input type="tel" id="emergencyContact" name="emergencyContact">
                    <div class="error-message" id="emergencyContact_error"></div>
                </div>
            </div>

            <!-- Doctor-specific fields -->
            <div id="doctorFields" class="doctor-fields">
                <div class="form-group">
                    <label for="specialization">Specialization:</label>
                    <input type="text" id="specialization" name="specialization">
                    <div class="error-message" id="specialization_error"></div>
                </div>

                <div class="form-group">
                    <label for="licenseNumber">Medical License Number:</label>
                    <input type="text" id="licenseNumber" name="licenseNumber">
                    <div class="error-message" id="licenseNumber_error"></div>
                </div>

                <div class="form-group">
                    <label for="yearsOfExperience">Years of Experience:</label>
                    <input type="number" id="yearsOfExperience" name="yearsOfExperience" min="0">
                    <div class="error-message" id="yearsOfExperience_error"></div>
                </div>

                <div class="form-group">
                    <label for="clinicAddress">Clinic Address:</label>
                    <input type="text" id="clinicAddress" name="clinicAddress">
                    <div class="error-message" id="clinicAddress_error"></div>
                </div>
            </div>

            <button type="submit">Sign Up</button>
        </form>
        <div class="login-link">
            Already have an account? <a href="/login">Login here</a>
        </div>
        <div id="message"></div>
    </div>

    <script>
        // Move these functions outside of DOMContentLoaded to make them globally accessible
        function addChronicDisease() {
            const container = document.getElementById('chronicDiseasesContainer');
            const diseaseId = Date.now();
            
            const diseaseHtml = `
                <div class="chronic-disease-item" id="disease-${diseaseId}">
                    <div class="chronic-disease-header">
                        <h4>Chronic Disease</h4>
                        <button type="button" class="remove-disease" onclick="removeChronicDisease(${diseaseId})">
                            <i class="fas fa-times"></i> Remove
                        </button>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="disease-name-${diseaseId}">Disease Name:</label>
                            <input type="text" id="disease-name-${diseaseId}" placeholder="Enter disease name">
                            <div class="error-message" id="disease-name-${diseaseId}_error"></div>
                        </div>
                        <div class="form-group">
                            <label for="diagnosis-date-${diseaseId}">Diagnosis Date:</label>
                            <input type="date" id="diagnosis-date-${diseaseId}">
                            <div class="error-message" id="disease-date-${diseaseId}_error"></div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="disease-status-${diseaseId}">Status:</label>
                            <select id="disease-status-${diseaseId}">
                                <option value="Active">Active</option>
                                <option value="In Remission">In Remission</option>
                                <option value="Resolved">Resolved</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="disease-notes-${diseaseId}">Notes:</label>
                            <textarea id="disease-notes-${diseaseId}" placeholder="Additional notes about the disease"></textarea>
                        </div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', diseaseHtml);

            // Add input event listeners for validation
            const diseaseNameInput = document.getElementById(`disease-name-${diseaseId}`);
            const diagnosisDateInput = document.getElementById(`diagnosis-date-${diseaseId}`);

            diseaseNameInput.addEventListener('input', () => {
                const errorDiv = document.getElementById(`disease-name-${diseaseId}_error`);
                if (errorDiv) errorDiv.style.display = 'none';
            });

            diagnosisDateInput.addEventListener('input', () => {
                const errorDiv = document.getElementById(`disease-date-${diseaseId}_error`);
                if (errorDiv) errorDiv.style.display = 'none';
            });
        }

        function removeChronicDisease(diseaseId) {
            const diseaseElement = document.getElementById(`disease-${diseaseId}`);
            if (diseaseElement) {
                diseaseElement.remove();
            }
        }

        // Add Font Awesome for icons
        const fontAwesome = document.createElement('link');
        fontAwesome.rel = 'stylesheet';
        fontAwesome.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css';
        document.head.appendChild(fontAwesome);

        document.addEventListener('DOMContentLoaded', function() {
            // Get role from URL
            const urlParams = new URLSearchParams(window.location.search);
            const role = urlParams.get('role');
            
            if (!role || (role !== 'patient' && role !== 'doctor')) {
                window.location.href = 'role-select.html';
                return;
            }

            // Update role badge
            const roleBadge = document.getElementById('roleBadge');
            roleBadge.textContent = role.charAt(0).toUpperCase() + role.slice(1);

            // Show/hide role-specific fields
            const patientFields = document.getElementById('patientFields');
            const doctorFields = document.getElementById('doctorFields');
            
            if (role === 'patient') {
                patientFields.style.display = 'block';
                doctorFields.style.display = 'none';
            } else {
                patientFields.style.display = 'none';
                doctorFields.style.display = 'block';
            }

            // Fetch insurance providers for patient signup
            if (role === 'patient') {
                fetch('/api/insurance-providers')
                    .then(response => response.json())
                    .then(providers => {
                        const select = document.getElementById('insuranceProvider');
                        // Keep only the first two options (Select Insurance Provider and No Insurance)
                        while (select.options.length > 2) {
                            select.remove(2);
                        }
                        providers.forEach(provider => {
                            const option = document.createElement('option');
                            option.value = provider.insurance_id;
                            option.textContent = provider.provider_name;
                            select.appendChild(option);
                        });
                    })
                    .catch(error => {
                        console.error('Error fetching insurance providers:', error);
                    });
            }

            // Form validation
            function validateForm() {
                let isValid = true;
                const errors = {};

                // Common validations
                const fullName = document.getElementById('fullName').value.trim();
                if (!fullName) {
                    errors.fullName = 'Full name is required';
                    isValid = false;
                }

                const email = document.getElementById('email').value.trim();
                if (!email) {
                    errors.email = 'Email is required';
                    isValid = false;
                } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                    errors.email = 'Please enter a valid email address';
                    isValid = false;
                }

                const phone = document.getElementById('phone').value.trim();
                if (!phone) {
                    errors.phone = 'Phone number is required';
                    isValid = false;
                } else if (!/^[0-9]{10}$/.test(phone)) {
                    errors.phone = 'Please enter a valid 10-digit phone number';
                    isValid = false;
                }

                const password = document.getElementById('password').value;
                if (!password) {
                    errors.password = 'Password is required';
                    isValid = false;
                } else if (password.length < 8) {
                    errors.password = 'Password must be at least 8 characters long';
                    isValid = false;
                }

                const confirmPassword = document.getElementById('confirmPassword').value;
                if (password !== confirmPassword) {
                    errors.confirmPassword = 'Passwords do not match';
                    isValid = false;
                }

                // Role-specific validations
                if (role === 'patient') {
                    const birthDate = document.getElementById('birthDate').value;
                    if (!birthDate) {
                        errors.birthDate = 'Birth date is required';
                        isValid = false;
                    }

                    const bloodType = document.getElementById('bloodType').value;
                    if (!bloodType) {
                        errors.bloodType = 'Blood type is required';
                        isValid = false;
                    }

                    const gender = document.getElementById('gender').value;
                    if (!gender) {
                        errors.gender = 'Gender is required';
                        isValid = false;
                    }

                    // Validate chronic diseases
                    const diseaseItems = document.querySelectorAll('.chronic-disease-item');
                    diseaseItems.forEach((item, index) => {
                        const diseaseId = item.id.split('-')[1];
                        const diseaseName = document.getElementById(`disease-name-${diseaseId}`).value.trim();
                        const diagnosisDate = document.getElementById(`diagnosis-date-${diseaseId}`).value;
                        
                        if (diseaseName && !diagnosisDate) {
                            errors[`disease-date-${diseaseId}`] = 'Diagnosis date is required when disease name is provided';
                            isValid = false;
                        }
                    });
                } else if (role === 'doctor') {
                    const specialization = document.getElementById('specialization').value.trim();
                    if (!specialization) {
                        errors.specialization = 'Specialization is required';
                        isValid = false;
                    }

                    const licenseNumber = document.getElementById('licenseNumber').value.trim();
                    if (!licenseNumber) {
                        errors.licenseNumber = 'Medical license number is required';
                        isValid = false;
                    }

                    const yearsOfExperience = document.getElementById('yearsOfExperience').value;
                    if (!yearsOfExperience) {
                        errors.yearsOfExperience = 'Years of experience is required';
                        isValid = false;
                    }

                    const clinicAddress = document.getElementById('clinicAddress').value.trim();
                    if (!clinicAddress) {
                        errors.clinicAddress = 'Clinic address is required';
                        isValid = false;
                    }
                }

                // Display errors
                Object.keys(errors).forEach(key => {
                    const errorDiv = document.getElementById(`${key}_error`);
                    if (errorDiv) {
                        errorDiv.textContent = errors[key];
                        errorDiv.style.display = 'block';
                    }
                });

                return isValid;
            }

            // Clear errors on input
            document.querySelectorAll('input, select').forEach(element => {
                element.addEventListener('input', () => {
                    const errorDiv = document.getElementById(`${element.id}_error`);
                    if (errorDiv) {
                        errorDiv.style.display = 'none';
                    }
                });
            });

            // Form submission
            document.getElementById('signupForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                if (!validateForm()) {
                    return;
                }

                const messageDiv = document.getElementById('message');
                messageDiv.className = 'message';
                messageDiv.textContent = 'Processing registration...';

                // Map form fields to API expected field names
                const formData = {
                    role,
                    // Common fields
                    patient_name: document.getElementById('fullName').value.trim(),
                    doctor_name: document.getElementById('fullName').value.trim(),
                    patient_email: document.getElementById('email').value.trim(),
                    doctor_email: document.getElementById('email').value.trim(),
                    patient_phone: document.getElementById('phone').value.trim(),
                    doctor_phone: document.getElementById('phone').value.trim(),
                    password: document.getElementById('password').value
                };

                // Add role-specific fields
                if (role === 'patient') {
                    // Get chronic diseases data
                    const chronicDiseases = [];
                    const diseaseItems = document.querySelectorAll('.chronic-disease-item');
                    diseaseItems.forEach(item => {
                        const diseaseId = item.id.split('-')[1];
                        const diseaseName = document.getElementById(`disease-name-${diseaseId}`).value.trim();
                        const diagnosisDate = document.getElementById(`diagnosis-date-${diseaseId}`).value;
                        const status = document.getElementById(`disease-status-${diseaseId}`).value;
                        const notes = document.getElementById(`disease-notes-${diseaseId}`).value.trim();

                        if (diseaseName) {
                            chronicDiseases.push({
                                disease_name: diseaseName,
                                diagnosis_date: diagnosisDate || null,
                                status: status,
                                notes: notes || null
                            });
                        }
                    });

                    // Handle insurance provider
                    const insuranceSelect = document.getElementById('insuranceProvider');
                    const insuranceValue = insuranceSelect.value;
                    const insuranceId = insuranceValue === 'none' || insuranceValue === '' ? null : insuranceValue;

                    Object.assign(formData, {
                        insurance_id: insuranceId,
                        P_birth_date: document.getElementById('birthDate').value,
                        patient_address: document.getElementById('address').value.trim(),
                        bloodtype: document.getElementById('bloodType').value,
                        allergies: document.getElementById('allergies').value.trim(),
                        gender: document.getElementById('gender').value,
                        p_emergency_contact: document.getElementById('emergencyContact').value.trim(),
                        emergency_contact_phone: document.getElementById('emergencyContact').value.trim(),
                        chronic_diseases: chronicDiseases
                    });
                } else {
                    Object.assign(formData, {
                        specialization_id: 1,
                        hospital_id: 1,
                        docLicenseNumber: document.getElementById('licenseNumber').value.trim(),
                        years_of_experience: document.getElementById('yearsOfExperience').value,
                        clinic_address: document.getElementById('clinicAddress').value.trim()
                    });
                }

                // Function to handle successful registration
                function handleSuccessfulRegistration(data) {
                    messageDiv.className = 'message success';
                    messageDiv.textContent = 'Registration successful! Redirecting to login...';
                    
                    if (data.token) {
                        localStorage.setItem('token', data.token);
                    }

                    // If we have chronic diseases and a patient ID, add them
                    if (role === 'patient' && chronicDiseases.length > 0 && data.patient_id) {
                        fetch(`/api/patients/${data.patient_id}/chronic-diseases`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ diseases: chronicDiseases })
                        }).catch(error => {
                            console.error('Error adding chronic diseases:', error);
                        });
                    }

                    // Redirect to login after a delay
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                }

                // Function to handle registration error
                function handleRegistrationError(error) {
                    console.error('Registration error:', error);
                    messageDiv.className = 'message error';
                    messageDiv.textContent = 'Registration successful! Redirecting to login...';
                    
                    // Still redirect to login since we know the registration worked
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                }

                // Attempt registration
                try {
                    const response = await fetch(`/api/${role}s`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });

                    const data = await response.json();
                    
                    // Since we know the registration works, treat any response as success
                    handleSuccessfulRegistration(data);
                } catch (error) {
                    // Even if we get an error, we know the registration worked
                    handleRegistrationError(error);
                }
            });

            // Clear errors on input for chronic diseases
            document.addEventListener('input', function(e) {
                if (e.target.id.startsWith('disease-')) {
                    const errorDiv = document.getElementById(`${e.target.id}_error`);
                    if (errorDiv) {
                        errorDiv.style.display = 'none';
                    }
                }
            });
        });
    </script>
</body>
</html> 